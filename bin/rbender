#!/usr/bin/env ruby
# frozen_string_literal: true

require 'colorize'
require 'gli'
require 'hacer'
require 'rbender'
require 'rbender/utils'

class RBenderCLI
  extend GLI::App
  PROJECT_ROOT_REQUIRED_COMMANDS = [:server, :schema]

  program_desc 'RBender app launcher'
  version RBender::VERSION
  subcommand_option_handling :normal
  sort_help :manually

  arg :mode, :optional
  default_value 'dev'
  flag [:m, :mode],
    arg_name: 'env',
    must_match: ['prod', 'dev', 'staging'],
    desc: 'Environment mode(available: prod, dev, staging)'
  flag [:d, :dir], arg_name: 'dir', desc: 'Project\'s working directory'

  pre do |global_opts, command, _opts, _args|
    set_work_dir!(global_opts)
    find_root_dir! if project_required_command?(command)

    true
  end

  desc 'Creates new RBender project'
  arg '<<ProjectName>>'
  command :new do |c|
    c.action do |global_opts, _, args|
      if args[0].nil?
        puts "Project name should be provided!\n".red
        puts 'Tip: ' + 'rbender new bot_name'.cyan
        next
      end
      params =
        {
          project_name: args[0],
          rbender_path: File.expand_path('..', __dir__),
        }
      params.merge!(global_opts.slice(:dir)).compact

      boilerplate = RBender::Utils::Boilerplate.new(params)
      boilerplate.generate_project!

      puts "\n" + boilerplate.work_dir.italic
    end
  end

  desc 'Starts bot server'
  command :server do |c|
    c.action do |_global_opts, _opts, _args|
      # RBender::Utils::Launcher.start!(options)
      puts 'Started(no)'
    end
  end

  desc "Telegram Bot Api Schema operations(print #{'rbender help schema'.cyan} for more)"
  command :schema do |schema|
    schema.desc 'Updates or restores Telegram Bot Api schema from GitHub(https://ark0f.github.io/tg-bot-api/custom.json)'
    schema.command :update do |update|
      update.action do
        RBender::Support::TelegramBotApiSchema.new.update!
        puts "Telegram Bot Api Schema was successfully updated!\n".green

        RBender::Support::TelegramBotApiSchema.print_schema_version
      end
    end

    schema.desc 'Prints Schema info'
    schema.command :info do |info|
      info.action do
        RBender::Support::TelegramBotApiSchema.print_schema_version
      end
    end
  end

  desc 'Outputs current gem version and author'
  command :about do |c|
    c.action { RBender.print_about }
  end

  class << self
    def find_root_dir!
      original_dir = Dir.getwd
      path = original_dir.split('/')
      path[0] = '/'
      loop do
        return true if RBender::Support::ConfigHandler.config_exist?

        path.delete_at(-1)
        break if path.empty?
        Dir.chdir(File.join(path))
      end

      raise "Not an RBender project directory!\n".red + original_dir.italic
    end

    def project_required_command?(command)
      ([command.name, command.parent&.name].compact & PROJECT_ROOT_REQUIRED_COMMANDS).any?
    end
    def project_subfolder?
      File.exist?(RBender::Support::ConfigHandler::CONFIG_PATH)
    end

    def set_work_dir!(global_opts)
      return unless global_opts[:dir]

      workdir_new =
        if global_opts[:dir][0] == '/'
          global_opts[:dir]
        else
          File.expand_path(global_opts[:dir], Dir.getwd)
        end
      raise "PATH NOT FOUND: #{workdir_new.italic}".red unless Dir.exist?(workdir_new)

      FileUtils.chdir(workdir_new)
    end
  end
end

exit RBenderCLI.run(ARGV)
